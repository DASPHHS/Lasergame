<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Lasergame</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: white;
            padding: 15px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .title {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1em;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .team-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .team-a {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .team-b {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .player-info {
            text-align: center;
        }

        .player-name {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .player-number {
            font-size: 3em;
            font-weight: bold;
            margin: 15px 0;
            opacity: 0.9;
        }

        .player-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 25px 0;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        .cooldown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(239, 68, 68, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .cooldown-timer {
            font-size: 8em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .cooldown-text {
            font-size: 1.5em;
            text-align: center;
        }

        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .qr-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            page-break-inside: avoid;
        }

        .qr-item-title {
            color: #000;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .qr-team-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        #videoContainer {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
        }

        #video {
            width: 100%;
            display: block;
        }

        canvas {
            display: none;
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 220px;
            border: 4px solid #10b981;
            border-radius: 15px;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .admin-scoreboard {
            padding: 30px;
        }

        .admin-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .admin-title {
            font-size: 3.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .teams-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .team-section {
            border-radius: 20px;
            padding: 30px;
        }

        .team-section.a {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(220, 38, 38, 0.3) 100%);
            border: 3px solid #ef4444;
        }

        .team-section.b {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3) 0%, rgba(37, 99, 235, 0.3) 100%);
            border: 3px solid #3b82f6;
        }

        .team-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .team-name {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .team-total-score {
            font-size: 4em;
            font-weight: bold;
        }

        .player-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .player-row-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .player-row-number {
            font-size: 1.5em;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-row-name {
            font-weight: 600;
        }

        .player-row-score {
            font-size: 1.4em;
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        .message {
            padding: 18px;
            border-radius: 15px;
            margin-bottom: 18px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1em;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.3);
            border: 2px solid #10b981;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.3);
            border: 2px solid #ef4444;
        }

        .message.info {
            background: rgba(59, 130, 246, 0.3);
            border: 2px solid #3b82f6;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1em;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #10b981;
        }

        .input-group select option {
            background: #1e293b;
            color: white;
        }

        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.15);
            border: 3px solid transparent;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-card:hover {
            transform: scale(1.05);
            border-color: #10b981;
        }

        .mode-card-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .mode-card-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .player-management-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .player-management-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .player-management-number {
            font-size: 1.3em;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-management-details {
            font-size: 1em;
        }

        .player-management-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .player-management-stats {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.7);
        }

        .btn-small {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-small:hover {
            transform: scale(1.05);
        }

        .btn-remove {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        @media print {
            body {
                background: white;
            }
            .no-print {
                display: none !important;
            }
            .card {
                box-shadow: none;
                background: white;
            }
            .qr-item {
                border: 2px solid #000;
            }
        }

        @media (max-width: 768px) {
            .teams-container {
                grid-template-columns: 1fr;
            }
            .admin-title {
                font-size: 2em;
            }
            .team-total-score {
                font-size: 2.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="modeScreen" class="card">
            <div class="header">
                <div class="title">üéØ QR Lasergame</div>
                <div class="subtitle">Kies je modus</div>
            </div>
            
            <div class="mode-selector">
                <div class="mode-card" onclick="selectMode('player')">
                    <div class="mode-card-icon">üì±</div>
                    <div class="mode-card-title">Speler</div>
                </div>
                <div class="mode-card" onclick="selectMode('admin')">
                    <div class="mode-card-icon">üìä</div>
                    <div class="mode-card-title">Admin Scorebord</div>
                </div>
            </div>
            
            <button class="btn btn-secondary" onclick="selectMode('print')">üñ®Ô∏è Print QR Codes (Nummers 1-20)</button>
        </div>

        <div id="printScreen" class="card hidden">
            <div class="no-print">
                <h2 style="margin-bottom: 20px;">üñ®Ô∏è Print deze 20 QR Codes</h2>
                <p style="margin-bottom: 15px; color: rgba(255,255,255,0.8);">
                    <strong>Oneven nummers (1,3,5...) = Team A (Rood)</strong><br>
                    <strong>Even nummers (2,4,6...) = Team B (Blauw)</strong>
                </p>
                <p style="margin-bottom: 25px; color: rgba(255,255,255,0.8);">
                    Knip de QR codes uit en bevestig ze op de rug van spelers met tape of hesjes.
                </p>
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print Pagina</button>
                <button class="btn btn-secondary" onclick="backToMode()">‚Üê Terug</button>
            </div>
            <div class="qr-grid" id="qrGrid"></div>
        </div>

        <div id="playerSetupScreen" class="card hidden">
            <h2 style="margin-bottom: 25px;">üë§ Speler Aanmelden</h2>
            <div class="input-group">
                <label>Je Naam:</label>
                <input type="text" id="playerNameInput" placeholder="Voer je naam in">
            </div>
            <div class="input-group">
                <label>Je Nummer (zie op je rug):</label>
                <select id="playerNumberSelect">
                    <option value="">-- Kies je nummer --</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="registerPlayer()">‚úÖ Start Spelen</button>
            <button class="btn btn-secondary" onclick="backToMode()">‚Üê Terug</button>
        </div>

        <div id="playerGameScreen" class="card hidden">
            <div id="messageArea"></div>
            
            <div class="player-info">
                <div id="playerTeamBadge" class="team-badge"></div>
                <div class="player-name" id="playerNameDisplay"></div>
                <div class="player-number">Nummer: <span id="playerNumberDisplay"></span></div>
                <div class="player-stats">
                    <div class="stat">
                        <div class="stat-value" id="playerScore">0</div>
                        <div class="stat-label">Punten</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="playerHits">0</div>
                        <div class="stat-label">Hits</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="playerDeaths">0</div>
                        <div class="stat-label">Geraakt</div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="startScanning()">üéØ Scan Tegenstander</button>
            <button class="btn btn-secondary" onclick="logoutPlayer()">‚Üê Uitloggen</button>
            <button class="btn btn-danger" onclick="removeSelfFromGame()">üóëÔ∏è Verwijder Mij uit Spel</button>
        </div>

        <div id="scanScreen" class="card hidden">
            <h2 style="margin-bottom: 20px; text-align: center;">üéØ Richt op QR code!</h2>
            <div id="scanDebug" style="background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; text-align: center;">
                <div>Status: <span id="scanStatus">Wachten op camera...</span></div>
                <div>Laatste scan: <span id="lastScan">Nog geen scan</span></div>
            </div>
            <div id="videoContainer">
                <video id="video" autoplay playsinline muted></video>
                <div class="scan-overlay"></div>
            </div>
            <canvas id="canvas"></canvas>
            <div style="text-align: center; margin-top: 20px; font-size: 1.1em; color: rgba(255,255,255,0.8);">
                Zoek een tegenstander en scan zijn QR code!
            </div>
            <button class="btn btn-secondary" onclick="stopScanning()" style="margin-top: 20px;">‚Üê Stop Scannen</button>
        </div>

        <div id="cooldownScreen" class="cooldown-overlay hidden">
            <div class="cooldown-timer" id="cooldownTimer">30</div>
            <div class="cooldown-text">üíÄ Je bent geraakt!<br>Wacht tot je weer kunt scannen...</div>
        </div>

        <div id="adminScreen" class="card hidden">
            <div class="admin-scoreboard">
                <div class="admin-header">
                    <div class="admin-title">üìä SCOREBORD</div>
                    <button class="btn btn-secondary no-print" onclick="refreshScoreboard()" style="max-width: 300px; margin: 20px auto;">üîÑ Ververs</button>
                    <button class="btn btn-danger no-print" onclick="resetAllGame()" style="max-width: 300px; margin: 10px auto;">üóëÔ∏è Reset Alles</button>
                    <button class="btn btn-secondary no-print" onclick="backToMode()" style="max-width: 300px; margin: 10px auto;">‚Üê Terug</button>
                </div>
                
                <div class="teams-container">
                    <div class="team-section a">
                        <div class="team-header">
                            <div class="team-name">üî¥ TEAM A</div>
                            <div class="team-total-score" id="adminTeamAScore">0</div>
                        </div>
                        <div id="adminTeamAPlayers"></div>
                    </div>
                    
                    <div class="team-section b">
                        <div class="team-header">
                            <div class="team-name">üîµ TEAM B</div>
                            <div class="team-total-score" id="adminTeamBScore">0</div>
                        </div>
                        <div id="adminTeamBPlayers"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var TOTAL_NUMBERS = 20;

        var gameState = {
            players: {},
            currentPlayer: null,
            scanning: false,
            cooldownActive: false,
            cooldownInterval: null
        };

        function getTeam(number) {
            return number % 2 === 1 ? 'A' : 'B';
        }

        function loadGameState() {
            var saved = localStorage.getItem('lasergame_global');
            if (saved) {
                try {
                    gameState.players = JSON.parse(saved);
                } catch(e) {
                    gameState.players = {};
                }
            }
            
            var currentPlayer = localStorage.getItem('lasergame_current_player');
            if (currentPlayer) {
                try {
                    gameState.currentPlayer = JSON.parse(currentPlayer);
                } catch(e) {
                    gameState.currentPlayer = null;
                }
            }
        }

        function saveGameState() {
            localStorage.setItem('lasergame_global', JSON.stringify(gameState.players));
            if (gameState.currentPlayer) {
                localStorage.setItem('lasergame_current_player', JSON.stringify(gameState.currentPlayer));
            }
        }

        function generateQRCodes() {
            var grid = document.getElementById('qrGrid');
            grid.innerHTML = '';
            
            for (var i = 1; i <= TOTAL_NUMBERS; i++) {
                var team = getTeam(i);
                
                var item = document.createElement('div');
                item.className = 'qr-item';
                
                var title = document.createElement('div');
                title.className = 'qr-item-title';
                title.textContent = 'NUMMER ' + i;
                
                var teamLabel = document.createElement('div');
                teamLabel.className = 'qr-team-label';
                teamLabel.textContent = 'Team ' + team + (team === 'A' ? ' (Rood)' : ' (Blauw)');
                
                var qrContainer = document.createElement('div');
                qrContainer.id = 'qr_' + i;
                
                item.appendChild(title);
                item.appendChild(teamLabel);
                item.appendChild(qrContainer);
                grid.appendChild(item);
                
                new QRCode(qrContainer, {
                    text: 'PLAYER_' + i,
                    width: 140,
                    height: 140
                });
            }
        }

        function populateNumberSelect() {
            var select = document.getElementById('playerNumberSelect');
            select.innerHTML = '<option value="">-- Kies je nummer --</option>';
            
            loadGameState();
            
            for (var i = 1; i <= TOTAL_NUMBERS; i++) {
                var option = document.createElement('option');
                option.value = i;
                var team = getTeam(i);
                option.textContent = 'Nummer ' + i + ' - Team ' + team + (team === 'A' ? ' (Rood)' : ' (Blauw)');
                
                if (gameState.players[i]) {
                    option.textContent += ' [' + gameState.players[i].name + ' - ' + gameState.players[i].score + ' pts]';
                }
                
                select.appendChild(option);
            }
        }

        function selectMode(mode) {
            hideAllScreens();
            
            if (mode === 'player') {
                if (gameState.currentPlayer) {
                    checkIfHit();
                    showScreen('playerGameScreen');
                    updatePlayerScreen();
                } else {
                    populateNumberSelect();
                    showScreen('playerSetupScreen');
                }
            } else if (mode === 'admin') {
                showScreen('adminScreen');
                refreshScoreboard();
                setInterval(refreshScoreboard, 3000);
            } else if (mode === 'print') {
                generateQRCodes();
                showScreen('printScreen');
            }
        }

        function hideAllScreens() {
            var screens = ['modeScreen', 'printScreen', 'playerSetupScreen', 'playerGameScreen', 'scanScreen', 'adminScreen'];
            screens.forEach(function(screen) {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        function showScreen(screenId) {
            hideAllScreens();
            document.getElementById(screenId).classList.remove('hidden');
        }

        function backToMode() {
            if (gameState.scanning) {
                stopScanning();
            }
            showScreen('modeScreen');
        }

        function registerPlayer() {
            var name = document.getElementById('playerNameInput').value.trim();
            var number = parseInt(document.getElementById('playerNumberSelect').value);
            
            if (!name) {
                alert('Voer je naam in!');
                return;
            }
            
            if (!number) {
                alert('Kies je nummer!');
                return;
            }
            
            loadGameState();
            
            if (gameState.players[number] && gameState.players[number].name !== name) {
                if (!confirm('Nummer ' + number + ' is al bezet door ' + gameState.players[number].name + '. Wil je deze speler overnemen?')) {
                    return;
                }
            }
            
            var team = getTeam(number);
            
            if (gameState.players[number]) {
                gameState.currentPlayer = gameState.players[number];
            } else {
                gameState.currentPlayer = {
                    number: number,
                    name: name,
                    team: team,
                    score: 0,
                    hits: 0,
                    deaths: 0,
                    scannedNumbers: []
                };
                gameState.players[number] = gameState.currentPlayer;
            }
            
            saveGameState();
            
            showScreen('playerGameScreen');
            updatePlayerScreen();
            showMessage('Welkom ' + gameState.currentPlayer.name + '! Je bent nummer ' + number + ' in Team ' + team, 'success');
        }

        function updatePlayerScreen() {
            var p = gameState.currentPlayer;
            document.getElementById('playerNameDisplay').textContent = p.name;
            document.getElementById('playerNumberDisplay').textContent = p.number;
            
            var badge = document.getElementById('playerTeamBadge');
            badge.textContent = 'Team ' + p.team;
            badge.className = 'team-badge team-' + p.team.toLowerCase();
            
            document.getElementById('playerScore').textContent = p.score;
            document.getElementById('playerHits').textContent = p.hits;
            document.getElementById('playerDeaths').textContent = p.deaths || 0;
        }

        function showMessage(message, type) {
            var messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = '<div class="message ' + type + '">' + message + '</div>';
            setTimeout(function() {
                messageArea.innerHTML = '';
            }, 4000);
        }

        function startScanning() {
            if (gameState.cooldownActive) {
                alert('Je bent in cooldown! Wacht tot je weer kunt scannen.');
                return;
            }

            showScreen('scanScreen');
            document.getElementById('scanStatus').textContent = 'Camera starten...';
            document.getElementById('lastScan').textContent = 'Nog geen scan';
            
            var video = document.getElementById('video');
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');

            gameState.scanning = true;

            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: { exact: 'environment' }
                } 
            }).catch(function() {
                return navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }
                });
            }).catch(function() {
                return navigator.mediaDevices.getUserMedia({ 
                    video: true
                });
            }).then(function(stream) {
                video.srcObject = stream;
                video.play();
                document.getElementById('scanStatus').textContent = 'Camera actief - Zoek QR code...';
                scan();
            }).catch(function(err) {
                console.error('Camera error:', err);
                document.getElementById('scanStatus').textContent = 'FOUT: ' + err.message;
                alert('Camera toegang geweigerd: ' + err.message);
                showScreen('playerGameScreen');
            });

            function scan() {
                if (!gameState.scanning) return;

                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    var code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        document.getElementById('lastScan').textContent = code.data;
                        
                        if (code.data.indexOf('PLAYER_') === 0) {
                            document.getElementById('scanStatus').textContent = '‚úÖ QR Code gevonden!';
                            handleScan(code.data);
                            return;
                        } else {
                            document.getElementById('scanStatus').textContent = 'Ongeldige QR (niet van dit spel)';
                        }
                    }
                }
                
                requestAnimationFrame(scan);
            }
        }

        function handleScan(data) {
            console.log('Scan ontvangen:', data);
            document.getElementById('scanStatus').textContent = 'Scan verwerken...';
            
            var targetNumber = parseInt(data.replace('PLAYER_', ''));
            console.log('Target nummer:', targetNumber);
            
            if (!targetNumber || targetNumber < 1 || targetNumber > TOTAL_NUMBERS) {
                console.log('Ongeldige nummer');
                showMessage('Ongeldige QR code!', 'error');
                setTimeout(function() { 
                    document.getElementById('scanStatus').textContent = 'Camera actief - Zoek QR code...';
                }, 1500);
                return;
            }
            
            if (targetNumber === gameState.currentPlayer.number) {
                console.log('Jezelf gescand');
                showMessage('Je kunt jezelf niet raken!', 'error');
                setTimeout(function() { 
                    document.getElementById('scanStatus').textContent = 'Camera actief - Zoek QR code...';
                }, 1500);
                return;
            }
            
            console.log('Laden gameState...');
            loadGameState();
            var targetPlayer = gameState.players[targetNumber];
            console.log('Target speler:', targetPlayer);
            
            if (!targetPlayer) {
                console.log('Speler niet aangemeld');
                showMessage('Nummer ' + targetNumber + ' heeft zich nog niet aangemeld!', 'error');
                setTimeout(function() { 
                    document.getElementById('scanStatus').textContent = 'Camera actief - Zoek QR code...';
                }, 1500);
                return;
            }
            
            console.log('Mijn team:', gameState.currentPlayer.team, 'Target team:', targetPlayer.team);
            if (targetPlayer.team === gameState.currentPlayer.team) {
                console.log('Eigen team');
                showMessage('Niet op je eigen team schieten!', 'error');
                setTimeout(function() { 
                    document.getElementById('scanStatus').textContent = 'Camera actief - Zoek QR code...';
                }, 1500);
                return;
            }
            
            if (gameState.currentPlayer.scannedNumbers.indexOf(targetNumber) !== -1) {
                console.log('Al eerder gescand');
                showMessage('Je hebt ' + targetPlayer.name + ' al geraakt eerder!', 'info');
                setTimeout(function() { 
                    document.getElementById('scanStatus').textContent = 'Camera actief - Zoek QR code...';
                }, 1500);
                return;
            }
            
            console.log('HIT! Punten toekennen...');
            gameState.currentPlayer.hits++;
            gameState.currentPlayer.score += 10;
            gameState.currentPlayer.scannedNumbers.push(targetNumber);
            
            if (!targetPlayer.deaths) {
                targetPlayer.deaths = 0;
            }
            targetPlayer.deaths++;
            targetPlayer.lastHitTime = Date.now();
            
            gameState.players[gameState.currentPlayer.number] = gameState.currentPlayer;
            gameState.players[targetNumber] = targetPlayer;
            saveGameState();
            
            console.log('Game state opgeslagen');
            stopScanning();
            updatePlayerScreen();
            
            var successDiv = document.createElement('div');
            successDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(16, 185, 129, 0.95); padding: 40px; border-radius: 20px; z-index: 9999; text-align: center; font-size: 2em; font-weight: bold;';
            successDiv.innerHTML = 'üéØ HIT!<br>+10 PUNTEN<br><br>Je raakte:<br>' + targetPlayer.name + '<br>(Nummer ' + targetNumber + ')';
            document.body.appendChild(successDiv);
            
            setTimeout(function() {
                if (document.body.contains(successDiv)) {
                    document.body.removeChild(successDiv);
                }
            }, 2500);
            
            console.log('Scan compleet!');
        }

        function notifyTarget(targetNumber) {
            var savedCurrentPlayer = localStorage.getItem('lasergame_current_player');
            if (savedCurrentPlayer) {
                var currentPlayer = JSON.parse(savedCurrentPlayer);
                if (currentPlayer.number === targetNumber) {
                    startCooldown();
                }
            }
        }

        function checkIfHit() {
            if (!gameState.currentPlayer) return;
            
            loadGameState();
            var myData = gameState.players[gameState.currentPlayer.number];
            
            if (myData && myData.lastHitTime) {
                var timeSinceHit = Date.now() - myData.lastHitTime;
                
                if (timeSinceHit < 30000 && !gameState.cooldownActive) {
                    var timeLeft = Math.ceil((30000 - timeSinceHit) / 1000);
                    startCooldownWithTime(timeLeft);
                }
            }
        }

        function startCooldown() {
            startCooldownWithTime(30);
        }

        function startCooldownWithTime(seconds) {
            gameState.cooldownActive = true;
            var cooldownScreen = document.getElementById('cooldownScreen');
            var cooldownTimer = document.getElementById('cooldownTimer');
            cooldownScreen.classList.remove('hidden');
            
            var timeLeft = seconds;
            cooldownTimer.textContent = timeLeft;
            
            if (gameState.cooldownInterval) {
                clearInterval(gameState.cooldownInterval);
            }
            
            gameState.cooldownInterval = setInterval(function() {
                timeLeft--;
                cooldownTimer.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(gameState.cooldownInterval);
                    gameState.cooldownActive = false;
                    cooldownScreen.classList.add('hidden');
                    showMessage('‚úÖ Je kunt weer scannen!', 'success');
                }
            }, 1000);
        }

        function stopScanning() {
            gameState.scanning = false;
            var video = document.getElementById('video');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(function(track) {
                    track.stop();
                });
            }
            showScreen('playerGameScreen');
        }

        function logoutPlayer() {
            if (confirm('Wil je uitloggen? Je score blijft bewaard.')) {
                if (gameState.cooldownInterval) {
                    clearInterval(gameState.cooldownInterval);
                }
                gameState.currentPlayer = null;
                gameState.cooldownActive = false;
                document.getElementById('cooldownScreen').classList.add('hidden');
                localStorage.removeItem('lasergame_current_player');
                backToMode();
            }
        }

        function removeSelfFromGame() {
            if (confirm('Weet je zeker dat je jezelf uit het spel wilt verwijderen? Al je punten worden gewist en je nummer wordt vrijgegeven.')) {
                if (confirm('Laatste bevestiging: Echt verwijderen?')) {
                    var myNumber = gameState.currentPlayer.number;
                    
                    delete gameState.players[myNumber];
                    saveGameState();
                    
                    if (gameState.cooldownInterval) {
                        clearInterval(gameState.cooldownInterval);
                    }
                    
                    gameState.currentPlayer = null;
                    gameState.cooldownActive = false;
                    document.getElementById('cooldownScreen').classList.add('hidden');
                    localStorage.removeItem('lasergame_current_player');
                    
                    alert('Je bent verwijderd uit het spel. Je kunt je opnieuw aanmelden met een nieuw nummer.');
                    backToMode();
                }
            }
        }

        function showPlayerManagement() {
            loadGameState();
            
            var list = document.getElementById('playerManagementList');
            list.innerHTML = '';
            
            if (Object.keys(gameState.players).length === 0) {
                list.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7);">Nog geen spelers aangemeld.</p>';
            } else {
                var sortedPlayers = Object.values(gameState.players).sort(function(a, b) {
                    return a.number - b.number;
                });
                
                sortedPlayers.forEach(function(player) {
                    var teamClass = player.team === 'A' ? 'team-a' : 'team-b';
                    var teamLabel = player.team === 'A' ? 'Team A (Rood)' : 'Team B (Blauw)';
                    
                    var item = document.createElement('div');
                    item.className = 'player-management-item';
                    item.innerHTML = 
                        '<div class="player-management-info">' +
                            '<div class="player-management-number">' + player.number + '</div>' +
                            '<div class="player-management-details">' +
                                '<div class="player-management-name">' + player.name + '</div>' +
                                '<div class="player-management-stats">' +
                                    teamLabel + ' ‚Ä¢ ' +
                                    player.score + ' punten ‚Ä¢ ' +
                                    player.hits + ' hits ‚Ä¢ ' +
                                    (player.deaths || 0) + ' geraakt' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<button class="btn-small btn-remove" onclick="removePlayer(' + player.number + ')">üóëÔ∏è Verwijder</button>';
                    
                    list.appendChild(item);
                });
            }
            
            showTab('playerManagement');
        }

        function removePlayer(playerNumber) {
            loadGameState();
            var player = gameState.players[playerNumber];
            
            if (!player) {
                alert('Speler niet gevonden!');
                return;
            }
            
            if (confirm('Wil je ' + player.name + ' (nummer ' + playerNumber + ') verwijderen uit het spel?')) {
                delete gameState.players[playerNumber];
                saveGameState();
                
                alert('Speler verwijderd! Nummer ' + playerNumber + ' is nu beschikbaar.');
                showPlayerManagement();
            }
        }

        function refreshScoreboard() {
            loadGameState();
            
            var teamAScore = 0;
            var teamBScore = 0;
            var teamAPlayers = [];
            var teamBPlayers = [];
            
            Object.values(gameState.players).forEach(function(player) {
                if (player.team === 'A') {
                    teamAScore += player.score;
                    teamAPlayers.push(player);
                } else {
                    teamBScore += player.score;
                    teamBPlayers.push(player);
                }
            });
            
            document.getElementById('adminTeamAScore').textContent = teamAScore;
            document.getElementById('adminTeamBScore').textContent = teamBScore;
            
            teamAPlayers.sort(function(a, b) { return b.score - a.score; });
            teamBPlayers.sort(function(a, b) { return b.score - a.score; });
            
            var teamADiv = document.getElementById('adminTeamAPlayers');
            teamADiv.innerHTML = '';
            teamAPlayers.forEach(function(player) {
                teamADiv.innerHTML += 
                    '<div class="player-row">' +
                        '<div class="player-row-info">' +
                            '<div class="player-row-number">' + player.number + '</div>' +
                            '<div class="player-row-name">' + player.name + '</div>' +
                        '</div>' +
                        '<div class="player-row-score">' + player.score + ' pts</div>' +
                    '</div>';
            });
            
            var teamBDiv = document.getElementById('adminTeamBPlayers');
            teamBDiv.innerHTML = '';
            teamBPlayers.forEach(function(player) {
                teamBDiv.innerHTML += 
                    '<div class="player-row">' +
                        '<div class="player-row-info">' +
                            '<div class="player-row-number">' + player.number + '</div>' +
                            '<div class="player-row-name">' + player.name + '</div>' +
                        '</div>' +
                        '<div class="player-row-score">' + player.score + ' pts</div>' +
                    '</div>';
            });
        }

        function resetAllGame() {
            if (confirm('WAARSCHUWING: Dit wist ALLE spelers en scores! Weet je het zeker?')) {
                if (confirm('Laatste kans! Echt alle data verwijderen?')) {
                    localStorage.clear();
                    gameState = {
                        players: {},
                        currentPlayer: null,
                        scanning: false
                    };
                    alert('Spel volledig gereset!');
                    backToMode();
                }
            }
        }

        loadGameState();
        
        setInterval(function() {
            if (gameState.currentPlayer) {
                checkIfHit();
            }
        }, 2000);
    </script>
</body>
</html>
