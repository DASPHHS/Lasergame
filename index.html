<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Lasergame</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: white;
            padding: 15px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .title {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1em;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .team-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .team-a {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .team-b {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .player-info {
            text-align: center;
        }

        .player-name {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .player-number {
            font-size: 3em;
            font-weight: bold;
            margin: 15px 0;
        }

        .player-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 25px 0;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn:hover {
            transform: scale(1.02);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .qr-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            page-break-inside: avoid;
        }

        .qr-item-title {
            color: #000;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .qr-team-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .hidden {
            display: none !important;
        }

        .message {
            padding: 18px;
            border-radius: 15px;
            margin-bottom: 18px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1em;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.3);
            border: 2px solid #10b981;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.3);
            border: 2px solid #ef4444;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1em;
        }

        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.15);
            border: 3px solid transparent;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-card:hover {
            transform: scale(1.05);
            border-color: #10b981;
        }

        .mode-card-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .mode-card-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .cooldown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(239, 68, 68, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .cooldown-timer {
            font-size: 8em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .cooldown-text {
            font-size: 1.5em;
            text-align: center;
        }

        #qr-reader-reg, #qr-reader-target {
            margin: 20px auto;
        }

        @media print {
            body {
                background: white;
            }
            .no-print {
                display: none !important;
            }
            .card {
                box-shadow: none;
                background: white;
            }
            .qr-item {
                border: 2px solid #000;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="modeScreen" class="card">
            <div class="header">
                <div class="title">üéØ QR Lasergame</div>
                <div class="subtitle">Kies je modus</div>
            </div>
            
            <div class="mode-selector">
                <div class="mode-card" onclick="gotoPlayer()">
                    <div class="mode-card-icon">üì±</div>
                    <div class="mode-card-title">Speler</div>
                </div>
                <div class="mode-card" onclick="gotoAdmin()">
                    <div class="mode-card-icon">üìä</div>
                    <div class="mode-card-title">Admin</div>
                </div>
            </div>
            
            <button class="btn btn-secondary" onclick="gotoPrint()">üñ®Ô∏è Print QR Codes</button>
        </div>

        <div id="printScreen" class="card hidden">
            <div class="no-print">
                <h2 style="margin-bottom: 20px;">üñ®Ô∏è Print QR Codes</h2>
                <p style="margin-bottom: 15px;">
                    <strong>Oneven (1,3,5...) = Team A (Rood)</strong><br>
                    <strong>Even (2,4,6...) = Team B (Blauw)</strong>
                </p>
                <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print</button>
                <button class="btn btn-secondary" onclick="gotoMode()">‚Üê Terug</button>
            </div>
            <div class="qr-grid" id="qrGrid"></div>
        </div>

        <div id="registerScreen" class="card hidden">
            <h2 style="margin-bottom: 20px;">üì± Scan je QR Code</h2>
            <p style="margin-bottom: 20px; text-align: center; color: rgba(255,255,255,0.8);">
                Scan de QR code op JOUW rug
            </p>
            <div id="qr-reader-reg"></div>
            <button class="btn btn-secondary" onclick="gotoMode()">‚Üê Terug</button>
        </div>

        <div id="nameScreen" class="card hidden">
            <h2 style="margin-bottom: 20px;">‚úèÔ∏è Vul je Naam in</h2>
            <p style="margin-bottom: 20px; text-align: center;">
                Je bent: <span id="regNumber" style="font-size: 1.5em; font-weight: bold;"></span>
            </p>
            <div class="input-group">
                <label>Jouw Naam:</label>
                <input type="text" id="nameInput" placeholder="Naam" autofocus>
            </div>
            <button class="btn btn-primary" onclick="finishRegistration()">‚úÖ Start</button>
            <button class="btn btn-secondary" onclick="gotoMode()">‚Üê Terug</button>
        </div>

        <div id="gameScreen" class="card hidden">
            <div id="msgArea"></div>
            
            <div class="player-info">
                <div id="teamBadge" class="team-badge"></div>
                <div class="player-name" id="playerName"></div>
                <div class="player-number">Nr: <span id="playerNum"></span></div>
                <div class="player-stats">
                    <div class="stat">
                        <div class="stat-value" id="score">0</div>
                        <div class="stat-label">Punten</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="hits">0</div>
                        <div class="stat-label">Hits</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="deaths">0</div>
                        <div class="stat-label">Geraakt</div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="startScan()">üéØ Scan Tegenstander</button>
            <button class="btn btn-danger" onclick="doLogout()">‚Üê Uitloggen</button>
        </div>

        <div id="scanScreen" class="card hidden">
            <h2 style="margin-bottom: 20px; text-align: center;">üéØ Scan Tegenstander</h2>
            <p style="margin-bottom: 20px; text-align: center; color: rgba(255,255,255,0.8);">
                Richt op QR code op rug van tegenstander
            </p>
            <div id="qr-reader-target"></div>
            <button class="btn btn-secondary" onclick="stopScan()">‚Üê Stop</button>
        </div>

        <div id="adminScreen" class="card hidden">
            <h2 style="margin-bottom: 20px; text-align: center;">üìä SCOREBORD</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div style="text-align: center; padding: 20px; background: rgba(239,68,68,0.3); border-radius: 15px;">
                    <div style="font-size: 1.5em; font-weight: bold;">üî¥ TEAM A</div>
                    <div style="font-size: 3em; font-weight: bold;" id="scoreA">0</div>
                    <div id="playersA"></div>
                </div>
                <div style="text-align: center; padding: 20px; background: rgba(59,130,246,0.3); border-radius: 15px;">
                    <div style="font-size: 1.5em; font-weight: bold;">üîµ TEAM B</div>
                    <div style="font-size: 3em; font-weight: bold;" id="scoreB">0</div>
                    <div id="playersB"></div>
                </div>
            </div>
            <button class="btn btn-danger" onclick="resetAll()">üîÑ Reset Alles</button>
            <button class="btn btn-secondary" onclick="gotoMode()">‚Üê Terug</button>
        </div>

        <div id="cooldown" class="cooldown-overlay hidden">
            <div class="cooldown-timer" id="cdTimer">30</div>
            <div class="cooldown-text">üíÄ Je bent geraakt!<br>Wacht...</div>
        </div>
    </div>

    <script>
        var game = {
            players: {},
            me: null,
            cd: false,
            cdInt: null,
            scanReg: null,
            scanTarget: null,
            adminInt: null
        };

        function load() {
            try {
                var p = localStorage.getItem('lg_players');
                if (p) game.players = JSON.parse(p);
                var m = localStorage.getItem('lg_me');
                if (m) game.me = JSON.parse(m);
            } catch(e) {}
        }

        function save() {
            localStorage.setItem('lg_players', JSON.stringify(game.players));
            if (game.me) localStorage.setItem('lg_me', JSON.stringify(game.me));
        }

        function getTeam(n) {
            return n % 2 === 1 ? 'A' : 'B';
        }

        function show(id) {
            ['modeScreen','printScreen','registerScreen','nameScreen','gameScreen','scanScreen','adminScreen'].forEach(function(s) {
                document.getElementById(s).classList.add('hidden');
            });
            document.getElementById(id).classList.remove('hidden');
        }

        function msg(txt, type) {
            var area = document.getElementById('msgArea');
            if (!area) return;
            area.innerHTML = '<div class="message ' + type + '">' + txt + '</div>';
            setTimeout(function() { area.innerHTML = ''; }, 3000);
        }

        function gotoMode() {
            stopAllScanners();
            if (game.adminInt) {
                clearInterval(game.adminInt);
                game.adminInt = null;
            }
            show('modeScreen');
        }

        function gotoPlayer() {
            load();
            if (game.me) {
                checkHit();
                updateGame();
                show('gameScreen');
            } else {
                show('registerScreen');
                setTimeout(startRegScan, 200);
            }
        }

        function gotoAdmin() {
            show('adminScreen');
            updateAdmin();
            if (game.adminInt) clearInterval(game.adminInt);
            game.adminInt = setInterval(updateAdmin, 2000);
        }

        function gotoPrint() {
            genQR();
            show('printScreen');
        }

        function genQR() {
            var grid = document.getElementById('qrGrid');
            grid.innerHTML = '';
            for (var i = 1; i <= 20; i++) {
                var div = document.createElement('div');
                div.className = 'qr-item';
                var t = getTeam(i);
                div.innerHTML = '<div class="qr-item-title">NUMMER ' + i + '</div>' +
                    '<div class="qr-team-label">Team ' + t + (t === 'A' ? ' (Rood)' : ' (Blauw)') + '</div>' +
                    '<div id="qr' + i + '"></div>';
                grid.appendChild(div);
                new QRCode(document.getElementById('qr' + i), {
                    text: 'PLAYER_' + i,
                    width: 140,
                    height: 140
                });
            }
        }

        function startRegScan() {
            if (game.scanReg) {
                try { game.scanReg.stop(); } catch(e) {}
            }
            game.scanReg = new Html5Qrcode("qr-reader-reg");
            game.scanReg.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                function(txt) {
                    if (txt.indexOf('PLAYER_') === 0) {
                        game.scanReg.stop().catch(function() {});
                        handleRegScan(txt);
                    }
                }
            ).catch(function(err) {
                alert('Camera fout: ' + err);
                gotoMode();
            });
        }

        function handleRegScan(txt) {
            var num = parseInt(txt.replace('PLAYER_', ''));
            if (!num || num < 1 || num > 20) {
                alert('Ongeldige QR!');
                return;
            }
            load();
            if (game.players[num]) {
                alert('Nummer ' + num + ' is bezet door ' + game.players[num].name);
                return;
            }
            game.regNum = num;
            document.getElementById('regNumber').textContent = 'Nummer ' + num + ' - Team ' + getTeam(num);
            show('nameScreen');
        }

        function finishRegistration() {
            var name = document.getElementById('nameInput').value.trim();
            if (!name) {
                alert('Voer je naam in!');
                return;
            }
            var num = game.regNum;
            var team = getTeam(num);
            game.me = {
                number: num,
                name: name,
                team: team,
                score: 0,
                hits: 0,
                deaths: 0,
                scanned: []
            };
            game.players[num] = game.me;
            save();
            updateGame();
            show('gameScreen');
            msg('Welkom ' + name + '! Team ' + team, 'success');
        }

        function updateGame() {
            if (!game.me) return;
            
            load();
            var updated = game.players[game.me.number];
            if (updated) {
                game.me = updated;
            }
            
            var p = game.me;
            document.getElementById('teamBadge').textContent = 'Team ' + p.team;
            document.getElementById('teamBadge').className = 'team-badge team-' + p.team.toLowerCase();
            document.getElementById('playerName').textContent = p.name;
            document.getElementById('playerNum').textContent = p.number;
            document.getElementById('score').textContent = p.score || 0;
            document.getElementById('hits').textContent = p.hits || 0;
            document.getElementById('deaths').textContent = p.deaths || 0;
        }

        function startScan() {
            if (game.cd) {
                alert('Je bent in cooldown!');
                return;
            }
            show('scanScreen');
            setTimeout(startTargetScan, 200);
        }

        function startTargetScan() {
            if (game.scanTarget) {
                try { game.scanTarget.stop(); } catch(e) {}
            }
            game.scanTarget = new Html5Qrcode("qr-reader-target");
            game.scanTarget.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                function(txt) {
                    if (txt.indexOf('PLAYER_') === 0) {
                        game.scanTarget.stop().catch(function() {});
                        handleHit(txt);
                    }
                }
            ).catch(function(err) {
                alert('Camera fout: ' + err);
                show('gameScreen');
            });
        }

        function handleHit(txt) {
            var num = parseInt(txt.replace('PLAYER_', ''));
            if (!num || num < 1 || num > 20) {
                msg('Ongeldige QR!', 'error');
                show('gameScreen');
                return;
            }
            if (num === game.me.number) {
                msg('Je kunt jezelf niet raken!', 'error');
                show('gameScreen');
                return;
            }
            var targetTeam = getTeam(num);
            if (targetTeam === game.me.team) {
                msg('Niet op eigen team!', 'error');
                show('gameScreen');
                return;
            }
            if (game.me.scanned.indexOf(num) !== -1) {
                msg('Al gescand!', 'error');
                show('gameScreen');
                return;
            }

            load();
            var target = game.players[num];
            
            if (target && target.lastHit) {
                var timeSince = Date.now() - target.lastHit;
                if (timeSince < 30000) {
                    msg('Target is in cooldown! Nog ' + Math.ceil((30000 - timeSince) / 1000) + ' sec', 'error');
                    show('gameScreen');
                    return;
                }
            }

            game.me.hits++;
            game.me.score += 10;
            game.me.scanned.push(num);

            if (target) {
                if (!target.deaths) target.deaths = 0;
                target.deaths++;
                target.lastHit = Date.now();
                game.players[num] = target;
            }
            
            game.players[game.me.number] = game.me;
            save();

            show('gameScreen');
            updateGame();
            
            var hitMsg = document.createElement('div');
            hitMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(16,185,129,0.95);padding:40px;border-radius:20px;z-index:9999;text-align:center;font-size:2em;font-weight:bold;';
            hitMsg.innerHTML = 'üéØ HIT!<br>+10 PUNTEN!<br><br>' + (target ? target.name : 'Nummer ' + num) + '<br><br>Jouw score: ' + game.me.score;
            document.body.appendChild(hitMsg);
            setTimeout(function() {
                if (document.body.contains(hitMsg)) document.body.removeChild(hitMsg);
            }, 3000);
        }

        function stopScan() {
            if (game.scanTarget) {
                game.scanTarget.stop().catch(function() {});
            }
            show('gameScreen');
        }

        function stopAllScanners() {
            if (game.scanReg) {
                try { game.scanReg.stop(); } catch(e) {}
            }
            if (game.scanTarget) {
                try { game.scanTarget.stop(); } catch(e) {}
            }
        }

        function doLogout() {
            if (!game.me) return;
            if (!confirm('Uitloggen? Je nummer wordt vrij.')) return;
            
            var num = game.me.number;
            load();
            delete game.players[num];
            localStorage.setItem('lg_players', JSON.stringify(game.players));
            localStorage.removeItem('lg_me');
            game.me = null;
            
            if (game.cdInt) {
                clearInterval(game.cdInt);
                game.cdInt = null;
            }
            game.cd = false;
            document.getElementById('cooldown').classList.add('hidden');
            
            alert('Uitgelogd! Nummer ' + num + ' is vrij.');
            gotoMode();
        }

        function checkHit() {
            if (!game.me) return;
            load();
            var myData = game.players[game.me.number];
            if (myData && myData.lastHit) {
                var diff = Date.now() - myData.lastHit;
                if (diff < 30000 && !game.cd) {
                    var left = Math.ceil((30000 - diff) / 1000);
                    startCD(left);
                    game.me.deaths = myData.deaths;
                    game.me.score = myData.score;
                    game.me.hits = myData.hits;
                    updateGame();
                }
            }
            
            if (myData) {
                game.me.score = myData.score || 0;
                game.me.hits = myData.hits || 0;
                game.me.deaths = myData.deaths || 0;
                updateGame();
            }
        }

        function startCD(sec) {
            game.cd = true;
            document.getElementById('cooldown').classList.remove('hidden');
            document.getElementById('cdTimer').textContent = sec;
            
            if (game.cdInt) clearInterval(game.cdInt);
            game.cdInt = setInterval(function() {
                sec--;
                document.getElementById('cdTimer').textContent = sec;
                if (sec <= 0) {
                    clearInterval(game.cdInt);
                    game.cd = false;
                    document.getElementById('cooldown').classList.add('hidden');
                    msg('‚úÖ Je kunt weer scannen!', 'success');
                }
            }, 1000);
        }

        function updateAdmin() {
            load();
            var scoreA = 0, scoreB = 0;
            var playersA = [], playersB = [];
            
            Object.keys(game.players).forEach(function(key) {
                var p = game.players[key];
                if (!p || !p.name) return;
                
                if (p.team === 'A') {
                    scoreA += (p.score || 0);
                    playersA.push(p);
                } else {
                    scoreB += (p.score || 0);
                    playersB.push(p);
                }
            });

            document.getElementById('scoreA').textContent = scoreA;
            document.getElementById('scoreB').textContent = scoreB;

            playersA.sort(function(a, b) { return (b.score || 0) - (a.score || 0); });
            playersB.sort(function(a, b) { return (b.score || 0) - (a.score || 0); });

            var htmlA = '';
            if (playersA.length === 0) {
                htmlA = '<div style="padding:10px;color:rgba(255,255,255,0.5);">Geen spelers</div>';
            } else {
                playersA.forEach(function(p) {
                    htmlA += '<div style="padding:8px;margin:5px 0;background:rgba(255,255,255,0.1);border-radius:8px;display:flex;justify-content:space-between;"><span>#' + p.number + ' ' + p.name + '</span><span>' + (p.score || 0) + ' pts</span></div>';
                });
            }
            document.getElementById('playersA').innerHTML = htmlA;

            var htmlB = '';
            if (playersB.length === 0) {
                htmlB = '<div style="padding:10px;color:rgba(255,255,255,0.5);">Geen spelers</div>';
            } else {
                playersB.forEach(function(p) {
                    htmlB += '<div style="padding:8px;margin:5px 0;background:rgba(255,255,255,0.1);border-radius:8px;display:flex;justify-content:space-between;"><span>#' + p.number + ' ' + p.name + '</span><span>' + (p.score || 0) + ' pts</span></div>';
                });
            }
            document.getElementById('playersB').innerHTML = htmlB;
        }

        function resetAll() {
            if (!confirm('ALLES wissen?')) return;
            if (!confirm('Zeker weten?')) return;
            localStorage.clear();
            game = {
                players: {},
                me: null,
                cd: false,
                cdInt: null,
                scanReg: null,
                scanTarget: null,
                adminInt: null
            };
            alert('Gereset!');
            gotoMode();
        }

        load();
        setInterval(function() {
            if (game.me) checkHit();
        }, 2000);
    </script>
</body>
</html>
