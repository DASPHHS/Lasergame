<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Lasergame</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: white;
            padding: 15px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
        }

        .title {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1em;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .team-badge {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        .team-a {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .team-b {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .player-info {
            text-align: center;
        }

        .player-name {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .player-number {
            font-size: 3em;
            font-weight: bold;
            margin: 15px 0;
            opacity: 0.9;
        }

        .player-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 25px 0;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: scale(0.98);
        }

        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .qr-item {
            background: white;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            page-break-inside: avoid;
        }

        .qr-item-title {
            color: #000;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .qr-team-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        #videoContainer {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
        }

        #video, #videoReg {
            width: 100%;
            display: block;
        }

        canvas {
            display: none;
        }

        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 220px;
            height: 220px;
            border: 4px solid #10b981;
            border-radius: 15px;
            pointer-events: none;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .admin-scoreboard {
            padding: 30px;
        }

        .admin-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .admin-title {
            font-size: 3.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .teams-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .team-section {
            border-radius: 20px;
            padding: 30px;
        }

        .team-section.a {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.3) 0%, rgba(220, 38, 38, 0.3) 100%);
            border: 3px solid #ef4444;
        }

        .team-section.b {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.3) 0%, rgba(37, 99, 235, 0.3) 100%);
            border: 3px solid #3b82f6;
        }

        .team-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .team-name {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .team-total-score {
            font-size: 4em;
            font-weight: bold;
        }

        .player-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .player-row-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .player-row-number {
            font-size: 1.5em;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.2);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-row-name {
            font-weight: 600;
        }

        .player-row-score {
            font-size: 1.4em;
            font-weight: bold;
        }

        .hidden {
            display: none !important;
        }

        .message {
            padding: 18px;
            border-radius: 15px;
            margin-bottom: 18px;
            text-align: center;
            font-weight: 600;
            font-size: 1.1em;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.3);
            border: 2px solid #10b981;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.3);
            border: 2px solid #ef4444;
        }

        .message.info {
            background: rgba(59, 130, 246, 0.3);
            border: 2px solid #3b82f6;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1em;
        }

        .input-group input:focus {
            outline: none;
            border-color: #10b981;
        }

        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .mode-card {
            background: rgba(255, 255, 255, 0.15);
            border: 3px solid transparent;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-card:hover {
            transform: scale(1.05);
            border-color: #10b981;
        }

        .mode-card-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .mode-card-title {
            font-size: 1.5em;
            font-weight: bold;
        }

        .cooldown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(239, 68, 68, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .cooldown-timer {
            font-size: 8em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .cooldown-text {
            font-size: 1.5em;
            text-align: center;
        }

        @media print {
            body {
                background: white;
            }
            .no-print {
                display: none !important;
            }
            .card {
                box-shadow: none;
                background: white;
            }
            .qr-item {
                border: 2px solid #000;
            }
        }

        @media (max-width: 768px) {
            .teams-container {
                grid-template-columns: 1fr;
            }
            .admin-title {
                font-size: 2em;
            }
            .team-total-score {
                font-size: 2.5em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="modeScreen" class="card">
            <div class="header">
                <div class="title">🎯 QR Lasergame</div>
                <div class="subtitle">Kies je modus</div>
            </div>
            
            <div class="mode-selector">
                <div class="mode-card" onclick="selectMode('player')">
                    <div class="mode-card-icon">📱</div>
                    <div class="mode-card-title">Speler</div>
                </div>
                <div class="mode-card" onclick="selectMode('admin')">
                    <div class="mode-card-icon">📊</div>
                    <div class="mode-card-title">Admin Scorebord</div>
                </div>
            </div>
            
            <button class="btn btn-secondary" onclick="selectMode('print')">🖨️ Print QR Codes (Nummers 1-20)</button>
        </div>

        <div id="printScreen" class="card hidden">
            <div class="no-print">
                <h2 style="margin-bottom: 20px;">🖨️ Print deze 20 QR Codes</h2>
                <p style="margin-bottom: 15px; color: rgba(255,255,255,0.8);">
                    <strong>Oneven nummers (1,3,5...) = Team A (Rood)</strong><br>
                    <strong>Even nummers (2,4,6...) = Team B (Blauw)</strong>
                </p>
                <p style="margin-bottom: 25px; color: rgba(255,255,255,0.8);">
                    Knip de QR codes uit en bevestig ze op de rug van spelers met tape of hesjes.
                </p>
                <button class="btn btn-primary" onclick="window.print()">🖨️ Print Pagina</button>
                <button class="btn btn-secondary" onclick="backToMode()">← Terug</button>
            </div>
            <div class="qr-grid" id="qrGrid"></div>
        </div>

        <div id="registerScreen" class="card hidden">
            <h2 style="margin-bottom: 25px;">📱 Scan je EIGEN QR Code</h2>
            <p style="margin-bottom: 20px; color: rgba(255,255,255,0.8); text-align: center;">
                Richt de camera op de QR code die op JOUW rug hangt
            </p>
            <div id="qr-reader-reg" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
            <button class="btn btn-secondary" onclick="stopRegistration()" style="margin-top: 20px;">← Terug</button>
        </div>

        <div id="nameScreen" class="card hidden">
            <h2 style="margin-bottom: 25px;">✏️ Vul je Naam in</h2>
            <p style="margin-bottom: 20px; text-align: center;">
                Je bent: <span id="registerNumber" style="font-size: 1.5em; font-weight: bold;"></span>
            </p>
            <div class="input-group">
                <label>Jouw Naam:</label>
                <input type="text" id="playerNameInput" placeholder="Voer je naam in" autofocus>
            </div>
            <button class="btn btn-primary" onclick="confirmRegistration()">✅ Start Spelen</button>
            <button class="btn btn-secondary" onclick="backToMode()">← Terug</button>
        </div>

        <div id="playerGameScreen" class="card hidden">
            <div id="messageArea"></div>
            
            <div class="player-info">
                <div id="playerTeamBadge" class="team-badge"></div>
                <div class="player-name" id="playerNameDisplay"></div>
                <div class="player-number">Nummer: <span id="playerNumberDisplay"></span></div>
                <div class="player-stats">
                    <div class="stat">
                        <div class="stat-value" id="playerScore">0</div>
                        <div class="stat-label">Punten</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="playerHits">0</div>
                        <div class="stat-label">Hits</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="playerDeaths">0</div>
                        <div class="stat-label">Geraakt</div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="startScanning()">🎯 Scan Tegenstander</button>
            <button class="btn btn-danger" onclick="logoutPlayer()">← Uitloggen (Geeft Nummer Vrij)</button>
        </div>

        <div id="scanScreen" class="card hidden">
            <h2 style="margin-bottom: 20px; text-align: center;">🎯 Scan Tegenstander!</h2>
            <p style="margin-bottom: 20px; color: rgba(255,255,255,0.8); text-align: center;">
                Richt de camera op de QR code op de rug van een tegenstander
            </p>
            <div id="qr-reader-target" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
            <button class="btn btn-secondary" onclick="stopScanning()" style="margin-top: 20px;">← Stop Scannen</button>
        </div>

        <div id="cooldownScreen" class="cooldown-overlay hidden">
            <div class="cooldown-timer" id="cooldownTimer">30</div>
            <div class="cooldown-text">💀 Je bent geraakt!<br>Wacht tot je weer kunt scannen...</div>
        </div>

        <div id="adminScreen" class="card hidden">
            <div class="admin-scoreboard">
                <div class="admin-header">
                    <div class="admin-title">📊 SCOREBORD</div>
                    <button class="btn btn-secondary no-print" onclick="refreshScoreboard()" style="max-width: 300px; margin: 20px auto;">🔄 Ververs</button>
                    <button class="btn btn-danger no-print" onclick="resetAllGame()" style="max-width: 300px; margin: 10px auto;">🗑️ Reset Alles</button>
                    <button class="btn btn-secondary no-print" onclick="backToMode()" style="max-width: 300px; margin: 10px auto;">← Terug</button>
                </div>
                
                <div class="teams-container">
                    <div class="team-section a">
                        <div class="team-header">
                            <div class="team-name">🔴 TEAM A</div>
                            <div class="team-total-score" id="adminTeamAScore">0</div>
                        </div>
                        <div id="adminTeamAPlayers"></div>
                    </div>
                    
                    <div class="team-section b">
                        <div class="team-header">
                            <div class="team-name">🔵 TEAM B</div>
                            <div class="team-total-score" id="adminTeamBScore">0</div>
                        </div>
                        <div id="adminTeamBPlayers"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var TOTAL_NUMBERS = 20;

        var gameState = {
            players: {},
            currentPlayer: null,
            scanning: false,
            cooldownActive: false,
            cooldownInterval: null,
            registeringNumber: null,
            scoreboardInterval: null
        };

        function getTeam(number) {
            return number % 2 === 1 ? 'A' : 'B';
        }

        function loadGameState() {
            var saved = localStorage.getItem('lasergame_global');
            if (saved) {
                try {
                    gameState.players = JSON.parse(saved);
                } catch(e) {
                    gameState.players = {};
                }
            }
            
            var currentPlayer = localStorage.getItem('lasergame_current_player');
            if (currentPlayer) {
                try {
                    gameState.currentPlayer = JSON.parse(currentPlayer);
                } catch(e) {
                    gameState.currentPlayer = null;
                }
            }
        }

        function saveGameState() {
            localStorage.setItem('lasergame_global', JSON.stringify(gameState.players));
            if (gameState.currentPlayer) {
                localStorage.setItem('lasergame_current_player', JSON.stringify(gameState.currentPlayer));
            }
        }

        function generateQRCodes() {
            var grid = document.getElementById('qrGrid');
            grid.innerHTML = '';
            
            for (var i = 1; i <= TOTAL_NUMBERS; i++) {
                var team = getTeam(i);
                
                var item = document.createElement('div');
                item.className = 'qr-item';
                
                var title = document.createElement('div');
                title.className = 'qr-item-title';
                title.textContent = 'NUMMER ' + i;
                
                var teamLabel = document.createElement('div');
                teamLabel.className = 'qr-team-label';
                teamLabel.textContent = 'Team ' + team + (team === 'A' ? ' (Rood)' : ' (Blauw)');
                
                var qrContainer = document.createElement('div');
                qrContainer.id = 'qr_' + i;
                
                item.appendChild(title);
                item.appendChild(teamLabel);
                item.appendChild(qrContainer);
                grid.appendChild(item);
                
                new QRCode(qrContainer, {
                    text: 'PLAYER_' + i,
                    width: 140,
                    height: 140
                });
            }
        }

        function selectMode(mode) {
            hideAllScreens();
            
            if (mode === 'player') {
                if (gameState.currentPlayer) {
                    checkIfHit();
                    showScreen('playerGameScreen');
                    updatePlayerScreen();
                } else {
                    startRegistration();
                }
            } else if (mode === 'admin') {
                showScreen('adminScreen');
                refreshScoreboard();
                if (gameState.scoreboardInterval) {
                    clearInterval(gameState.scoreboardInterval);
                }
                gameState.scoreboardInterval = setInterval(refreshScoreboard, 2000);
            } else if (mode === 'print') {
                generateQRCodes();
                showScreen('printScreen');
            }
        }

        function hideAllScreens() {
            var screens = ['modeScreen', 'printScreen', 'registerScreen', 'nameScreen', 'playerGameScreen', 'scanScreen', 'adminScreen'];
            screens.forEach(function(screen) {
                document.getElementById(screen).classList.add('hidden');
            });
        }

        function showScreen(screenId) {
            hideAllScreens();
            document.getElementById(screenId).classList.remove('hidden');
        }

        function backToMode() {
            if (gameState.scanning) {
                stopScanning();
            }
            if (gameState.registerScanning) {
                stopRegistration();
            }
            if (gameState.scoreboardInterval) {
                clearInterval(gameState.scoreboardInterval);
                gameState.scoreboardInterval = null;
            }
            showScreen('modeScreen');
        }

        function startRegistration() {
            showScreen('registerScreen');
            document.getElementById('scanDebugReg').textContent = 'Camera starten...';
            
            var video = document.getElementById('videoReg');
            var canvas = document.getElementById('canvasReg');
            var ctx = canvas.getContext('2d');

            gameState.registerScanning = true;

            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            }).then(function(stream) {
                video.srcObject = stream;
                video.setAttribute('playsinline', true);
                video.play();
                document.getElementById('scanDebugReg').textContent = 'Camera actief! Richt op QR code...';
                scanRegister();
            }).catch(function(err) {
                console.error('Camera error:', err);
                document.getElementById('scanDebugReg').textContent = 'FOUT: ' + err.message;
                alert('Camera toegang geweigerd: ' + err.message);
                showScreen('modeScreen');
            });

            function scanRegister() {
                if (!gameState.registerScanning) return;

                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    if (canvas.width > 0 && canvas.height > 0) {
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        try {
                            var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            var code = jsQR(imageData.data, imageData.width, imageData.height, {
                                inversionAttempts: "dontInvert"
                            });
                            
                            if (code && code.data) {
                                console.log('QR gevonden:', code.data);
                                document.getElementById('scanDebugReg').textContent = 'Gevonden: ' + code.data;
                                if (code.data.indexOf('PLAYER_') === 0) {
                                    handleRegistrationScan(code.data);
                                    return;
                                } else {
                                    document.getElementById('scanDebugReg').textContent = 'Ongeldige QR - niet van dit spel';
                                }
                            }
                        } catch(e) {
                            console.error('Scan error:', e);
                            document.getElementById('scanDebugReg').textContent = 'Scan fout: ' + e.message;
                        }
                    } else {
                        document.getElementById('scanDebugReg').textContent = 'Wachten op video... ' + canvas.width + 'x' + canvas.height;
                    }
                }
                
                requestAnimationFrame(scanRegister);
            }
        }

        function handleRegistrationScan(data) {
            var number = parseInt(data.replace('PLAYER_', ''));
            
            if (!number || number < 1 || number > TOTAL_NUMBERS) {
                alert('Ongeldige QR code!');
                return;
            }

            loadGameState();
            if (gameState.players[number]) {
                alert('Dit nummer is al bezet door ' + gameState.players[number].name + '!');
                return;
            }

            gameState.registeringNumber = number;
            stopRegistration();
            
            var team = getTeam(number);
            document.getElementById('registerNumber').textContent = 'Nummer ' + number + ' - Team ' + team + (team === 'A' ? ' (Rood)' : ' (Blauw)');
            showScreen('nameScreen');
            document.getElementById('playerNameInput').focus();
        }

        function stopRegistration() {
            if (gameState.codeReader) {
                gameState.codeReader.reset();
            }
            gameState.registerScanning = false;
            showScreen('modeScreen');
        }

        function startScanning() {
            if (gameState.cooldownActive) {
                alert('Je bent in cooldown! Wacht tot je weer kunt scannen.');
                return;
            }

            showScreen('scanScreen');
            document.getElementById('scanDebugTarget').textContent = 'Camera starten...';
            
            var video = document.getElementById('video');
            var codeReader = new ZXing.BrowserQRCodeReader();

            codeReader.decodeFromVideoDevice(null, 'video', function(result, err) {
                if (result) {
                    document.getElementById('scanDebugTarget').textContent = 'QR gevonden: ' + result.text;
                    if (result.text.indexOf('PLAYER_') === 0) {
                        codeReader.reset();
                        handleScan(result.text);
                    } else {
                        document.getElementById('scanDebugTarget').textContent = 'Ongeldige QR - niet van dit spel';
                    }
                }
                if (err && !(err instanceof ZXing.NotFoundException)) {
                    console.error(err);
                    document.getElementById('scanDebugTarget').textContent = 'Error: ' + err;
                }
            }).then(function() {
                document.getElementById('scanDebugTarget').textContent = 'Camera actief! Scan tegenstander...';
            }).catch(function(err) {
                console.error(err);
                document.getElementById('scanDebugTarget').textContent = 'Camera fout: ' + err;
                alert('Camera toegang geweigerd: ' + err);
                showScreen('playerGameScreen');
            });

            gameState.targetCodeReader = codeReader;
        }

        function confirmRegistration() {
            var name = document.getElementById('playerNameInput').value.trim();
            
            if (!name) {
                alert('Voer je naam in!');
                return;
            }

            var number = gameState.registeringNumber;
            var team = getTeam(number);

            gameState.currentPlayer = {
                number: number,
                name: name,
                team: team,
                score: 0,
                hits: 0,
                deaths: 0,
                scannedNumbers: []
            };

            gameState.players[number] = gameState.currentPlayer;
            saveGameState();

            showScreen('playerGameScreen');
            updatePlayerScreen();
            showMessage('Welkom ' + name + '! Je bent nummer ' + number + ' in Team ' + team, 'success');
        }

        function updatePlayerScreen() {
            var p = gameState.currentPlayer;
            document.getElementById('playerNameDisplay').textContent = p.name;
            document.getElementById('playerNumberDisplay').textContent = p.number;
            
            var badge = document.getElementById('playerTeamBadge');
            badge.textContent = 'Team ' + p.team;
            badge.className = 'team-badge team-' + p.team.toLowerCase();
            
            document.getElementById('playerScore').textContent = p.score;
            document.getElementById('playerHits').textContent = p.hits;
            document.getElementById('playerDeaths').textContent = p.deaths || 0;
        }

        function showMessage(message, type) {
            var messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = '<div class="message ' + type + '">' + message + '</div>';
            setTimeout(function() {
                messageArea.innerHTML = '';
            }, 4000);
        }

        function startRegistration() {
            showScreen('registerScreen');
            document.getElementById('scanDebugReg').textContent = 'Camera starten...';
            
            var video = document.getElementById('videoReg');
            var codeReader = new ZXing.BrowserQRCodeReader();

            codeReader.decodeFromVideoDevice(null, 'videoReg', function(result, err) {
                if (result) {
                    document.getElementById('scanDebugReg').textContent = 'QR gevonden: ' + result.text;
                    if (result.text.indexOf('PLAYER_') === 0) {
                        codeReader.reset();
                        handleRegistrationScan(result.text);
                    } else {
                        document.getElementById('scanDebugReg').textContent = 'Ongeldige QR - niet van dit spel';
                    }
                }
                if (err && !(err instanceof ZXing.NotFoundException)) {
                    console.error(err);
                    document.getElementById('scanDebugReg').textContent = 'Error: ' + err;
                }
            }).then(function() {
                document.getElementById('scanDebugReg').textContent = 'Camera actief! Richt op je QR code...';
            }).catch(function(err) {
                console.error(err);
                document.getElementById('scanDebugReg').textContent = 'Camera fout: ' + err;
                alert('Camera toegang geweigerd: ' + err);
            });

            gameState.codeReader = codeReader;
        }

        function handleScan(data) {
            var targetNumber = parseInt(data.replace('PLAYER_', ''));
            
            if (!targetNumber || targetNumber < 1 || targetNumber > TOTAL_NUMBERS) {
                showMessage('Ongeldige QR code!', 'error');
                return;
            }
            
            if (targetNumber === gameState.currentPlayer.number) {
                showMessage('Je kunt jezelf niet raken!', 'error');
                return;
            }
            
            var targetTeam = getTeam(targetNumber);
            
            if (targetTeam === gameState.currentPlayer.team) {
                showMessage('Niet op je eigen team schieten!', 'error');
                return;
            }
            
            if (gameState.currentPlayer.scannedNumbers.indexOf(targetNumber) !== -1) {
                showMessage('Je hebt nummer ' + targetNumber + ' al gescand!', 'info');
                return;
            }
            
            gameState.currentPlayer.hits++;
            gameState.currentPlayer.score += 10;
            gameState.currentPlayer.scannedNumbers.push(targetNumber);
            
            loadGameState();
            var targetPlayer = gameState.players[targetNumber];
            if (targetPlayer) {
                if (!targetPlayer.deaths) {
                    targetPlayer.deaths = 0;
                }
                targetPlayer.deaths++;
                targetPlayer.lastHitTime = Date.now();
                gameState.players[targetNumber] = targetPlayer;
            }
            
            gameState.players[gameState.currentPlayer.number] = gameState.currentPlayer;
            saveGameState();
            
            stopScanning();
            updatePlayerScreen();
            
            var successDiv = document.createElement('div');
            successDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(16, 185, 129, 0.95); padding: 40px; border-radius: 20px; z-index: 9999; text-align: center; font-size: 2em; font-weight: bold;';
            if (targetPlayer) {
                successDiv.innerHTML = '🎯 HIT!<br>+10 PUNTEN<br><br>Je raakte:<br>' + targetPlayer.name + '<br>(Nummer ' + targetNumber + ')';
            } else {
                successDiv.innerHTML = '🎯 HIT!<br>+10 PUNTEN<br><br>Nummer ' + targetNumber + '<br>(Team ' + targetTeam + ')';
            }
            document.body.appendChild(successDiv);
            
            setTimeout(function() {
                if (document.body.contains(successDiv)) {
                    document.body.removeChild(successDiv);
                }
            }, 2500);
        }

        function stopScanning() {
            if (gameState.targetCodeReader) {
                gameState.targetCodeReader.reset();
            }
            gameState.scanning = false;
            showScreen('playerGameScreen');
        }

        function logoutPlayer() {
            if (confirm('Wil je uitloggen? Je nummer wordt VRIJGEGEVEN en iemand anders kan het gebruiken.')) {
                var myNumber = gameState.currentPlayer.number;
                
                delete gameState.players[myNumber];
                localStorage.setItem('lasergame_global', JSON.stringify(gameState.players));
                
                if (gameState.cooldownInterval) {
                    clearInterval(gameState.cooldownInterval);
                }
                
                gameState.currentPlayer = null;
                gameState.cooldownActive = false;
                document.getElementById('cooldownScreen').classList.add('hidden');
                localStorage.removeItem('lasergame_current_player');
                
                alert('Je bent uitgelogd! Je nummer is nu vrij.');
                backToMode();
            }
        }

        function checkIfHit() {
            if (!gameState.currentPlayer) return;
            
            loadGameState();
            var myData = gameState.players[gameState.currentPlayer.number];
            
            if (myData && myData.lastHitTime) {
                var timeSinceHit = Date.now() - myData.lastHitTime;
                
                if (timeSinceHit < 30000 && !gameState.cooldownActive) {
                    var timeLeft = Math.ceil((30000 - timeSinceHit) / 1000);
                    startCooldownWithTime(timeLeft);
                    
                    gameState.currentPlayer.deaths = myData.deaths;
                    updatePlayerScreen();
                }
            }
        }

        function startCooldownWithTime(seconds) {
            gameState.cooldownActive = true;
            var cooldownScreen = document.getElementById('cooldownScreen');
            var cooldownTimer = document.getElementById('cooldownTimer');
            cooldownScreen.classList.remove('hidden');
            
            var timeLeft = seconds;
            cooldownTimer.textContent = timeLeft;
            
            if (gameState.cooldownInterval) {
                clearInterval(gameState.cooldownInterval);
            }
            
            gameState.cooldownInterval = setInterval(function() {
                timeLeft--;
                cooldownTimer.textContent = timeLeft;
                
                if (timeLeft <= 0) {
                    clearInterval(gameState.cooldownInterval);
                    gameState.cooldownActive = false;
                    cooldownScreen.classList.add('hidden');
                    showMessage('✅ Je kunt weer scannen!', 'success');
                }
            }, 1000);
        }

        function refreshScoreboard() {
            loadGameState();
            
            var teamAScore = 0;
            var teamBScore = 0;
            var teamAPlayers = [];
            var teamBPlayers = [];
            
            Object.values(gameState.players).forEach(function(player) {
                if (player.team === 'A') {
                    teamAScore += player.score;
                    teamAPlayers.push(player);
                } else {
                    teamBScore += player.score;
                    teamBPlayers.push(player);
                }
            });
            
            document.getElementById('adminTeamAScore').textContent = teamAScore;
            document.getElementById('adminTeamBScore').textContent = teamBScore;
            
            teamAPlayers.sort(function(a, b) { return b.score - a.score; });
            teamBPlayers.sort(function(a, b) { return b.score - a.score; });
            
            var teamADiv = document.getElementById('adminTeamAPlayers');
            teamADiv.innerHTML = '';
            teamAPlayers.forEach(function(player) {
                teamADiv.innerHTML += 
                    '<div class="player-row">' +
                        '<div class="player-row-info">' +
                            '<div class="player-row-number">' + player.number + '</div>' +
                            '<div class="player-row-name">' + player.name + '</div>' +
                        '</div>' +
                        '<div class="player-row-score">' + player.score + ' pts</div>' +
                    '</div>';
            });
            
            var teamBDiv = document.getElementById('adminTeamBPlayers');
            teamBDiv.innerHTML = '';
            teamBPlayers.forEach(function(player) {
                teamBDiv.innerHTML += 
                    '<div class="player-row">' +
                        '<div class="player-row-info">' +
                            '<div class="player-row-number">' + player.number + '</div>' +
                            '<div class="player-row-name">' + player.name + '</div>' +
                        '</div>' +
                        '<div class="player-row-score">' + player.score + ' pts</div>' +
                    '</div>';
            });
        }

        function resetAllGame() {
            if (confirm('WAARSCHUWING: Dit wist ALLE spelers en scores! Weet je het zeker?')) {
                if (confirm('Laatste kans! Echt alle data verwijderen?')) {
                    localStorage.clear();
                    gameState = {
                        players: {},
                        currentPlayer: null,
                        scanning: false,
                        cooldownActive: false,
                        cooldownInterval: null,
                        registeringNumber: null
                    };
                    alert('Spel volledig gereset!');
                    backToMode();
                }
            }
        }

        loadGameState();
        
        setInterval(function() {
            if (gameState.currentPlayer) {
                checkIfHit();
            }
        }, 2000);
    </script>
</body>
</html>
